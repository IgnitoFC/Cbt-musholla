04.24 15.31
cbt.html
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBT Peserta</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f5f5; }
    header, footer {
      background: #222; color: white; padding: 10px 20px; display: flex;
      justify-content: space-between; align-items: center; flex-wrap: wrap;
    }
    .container { padding: 20px; max-width: 900px; margin: auto; }
    .question-box {
      background: white; padding: 20px; margin-bottom: 20px;
      border-radius: 10px; box-shadow: 0 0 10px #ccc;
    }
    .nav-buttons, .controls {
      display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
      margin: 20px 0;
    }
    .nav-buttons button {
      padding: 8px 12px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: bold;
    }
    .not-answered { background: white; color: black; border: 1px solid #ccc; }
    .answered { background: #28a745; color: white; }
    .submit-btn {
      background: #007bff; color: white; padding: 10px 30px;
      border: none; border-radius: 8px; font-size: 16px;
    }
    .submit-btn:disabled { background: #aaa; }
    .timer { font-weight: bold; font-size: 18px; color: #ff5555; }
    .btn-logout { background: red; color: white; padding: 6px 15px; border: none; border-radius: 5px; }
    .btn-logout:hover { background: darkred; }
  </style>
</head>
<body>
  <header>
    <div>Peserta: <span id="userNama"></span></div>
    <div class="timer" id="timer">00:00</div>
    <button class="btn-logout" onclick="logout()">Logout</button>
  </header>

  <div class="container">
    <div class="nav-buttons" id="daftarSoal"></div>
    <div id="soalContainer"></div>
    <div class="controls">
      <button onclick="soalSebelumnya()">Sebelumnya</button>
      <button onclick="soalSelanjutnya()">Selanjutnya</button>
      <button class="submit-btn" id="btnSubmit" onclick="submitJawaban()">Kumpulkan Jawaban</button>
    </div>
  </div>

  <footer>&copy; 2025 Musholla Nurul Ikhwan</footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-PGsyOliTaj-unpWwuB3cb9N11Gcpl7M",
      authDomain: "cbt-musholla.firebaseapp.com",
      projectId: "cbt-musholla",
      storageBucket: "cbt-musholla.appspot.com",
      messagingSenderId: "1012621765788",
      appId: "1:1012621765788:web:86ef7078db1811847d1159"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const username = localStorage.getItem("cbt_user");
    const mapel = localStorage.getItem("cbt_mapel");
    let soalData = [], jawaban = {}, indeksAktif = 0;
    const container = document.getElementById("soalContainer");
    const daftar = document.getElementById("daftarSoal");
    document.getElementById("userNama").textContent = username;

    function tampilkanSoal() {
      const soal = soalData[indeksAktif];
      const div = document.createElement("div");
      div.className = "question-box";
      let isi = `<h3>Soal ${soal.nomor}: ${soal.pertanyaan}</h3>`;
      for (const [k, v] of Object.entries(soal.opsi)) {
        const tipe = soal.tipe === "pgk" ? "checkbox" : "radio";
        const id = `soal${soal.nomor}_${k}`;
        const isChecked = (jawaban[soal.nomor] || []).includes(k) ? "checked" : "";
        isi += `<label><input id="${id}" type="${tipe}" name="soal${soal.nomor}" value="${k}" ${isChecked}
          onchange="simpanJawaban('${soal.nomor}', '${k}', '${soal.tipe}')"> ${k}. ${v}</label><br>`;
      }
      div.innerHTML = isi;
      container.innerHTML = "";
      container.appendChild(div);
      updateNavigasi();
    }

    function updateNavigasi() {
      daftar.innerHTML = "";
      soalData.forEach((s, i) => {
        const btn = document.createElement("button");
        btn.textContent = s.nomor;
        const jwb = jawaban[s.nomor];
        btn.className = jwb && jwb.length > 0 ? "answered" : "not-answered";
        btn.onclick = () => { indeksAktif = i; tampilkanSoal(); };
        daftar.appendChild(btn);
      });
    }

    function soalSelanjutnya() {
      if (indeksAktif < soalData.length - 1) {
        indeksAktif++;
        tampilkanSoal();
      }
    }

    function soalSebelumnya() {
      if (indeksAktif > 0) {
        indeksAktif--;
        tampilkanSoal();
      }
    }

    function simpanJawaban(nomor, pilihan, tipe) {
      if (!jawaban[nomor]) jawaban[nomor] = tipe === "pgk" ? [] : "";
      if (tipe === "pgk") {
        if (!jawaban[nomor].includes(pilihan)) {
          jawaban[nomor].push(pilihan);
        } else {
          jawaban[nomor] = jawaban[nomor].filter(p => p !== pilihan);
        }
      } else {
        jawaban[nomor] = pilihan;
      }
      localStorage.setItem("jawaban_siswa_" + mapel, JSON.stringify(jawaban));
      updateNavigasi();
    }

    function submitJawaban() {
      if (!confirm("Kumpulkan jawaban sekarang?")) return;
      document.querySelectorAll("input").forEach(i => i.disabled = true);
      document.getElementById("btnSubmit").disabled = true;
      koreksiDanSimpan();
    }

    async function koreksiDanSimpan() {
      const snap = await db.collection("soal_" + mapel).get();
      let benar = 0;
      snap.forEach(doc => {
        const d = doc.data();
        const jwbn = jawaban[d.nomor];
        if (d.tipe === "pgk") {
          if (
            Array.isArray(jwbn) &&
            Array.isArray(d.kunci) &&
            jwbn.length === d.kunci.length &&
            d.kunci.every(k => jwbn.includes(k))
          ) {
            benar++;
          }
        } else {
          if (jwbn === d.kunci) benar++;
        }
      });
      const nilai = Math.round((benar / soalData.length) * 100);
      await db.collection("nilai_" + mapel).doc(username).set({
        username, nilai, waktu: new Date().toISOString()
      });
      localStorage.removeItem("jawaban_siswa_" + mapel);
      alert("Jawaban berhasil disimpan. Anda akan logout.");
      logout();
    }

    async function loadSoal() {
      const snap = await db.collection("soal_" + mapel).orderBy("nomor").get();
      soalData = snap.docs.map(d => d.data());
      const simpan = localStorage.getItem("jawaban_siswa_" + mapel);
      if (simpan) jawaban = JSON.parse(simpan);
      tampilkanSoal();
    }

    async function mulaiTimerFirebase() {
      const ref = await db.collection("pengaturan_" + mapel).doc("waktuUjian").get();
      const akhir = new Date(ref.data().selesai);
      const timer = document.getElementById("timer");
      const interval = setInterval(() => {
        const sisa = Math.floor((akhir - new Date()) / 1000);
        if (sisa <= 0) {
          clearInterval(interval);
          submitJawaban();
        }
        const m = Math.floor(sisa / 60);
        const d = sisa % 60;
        timer.textContent = `${m}:${d.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function logout() {
      localStorage.removeItem("cbt_user");
      location.href = "login.html";
    }

    document.addEventListener("visibilitychange", () => { if (document.hidden) logout(); });
    window.addEventListener("blur", () => logout());
    window.addEventListener("pagehide", () => logout());

    loadSoal();
    mulaiTimerFirebase();
  </script>
</body>
</html>
